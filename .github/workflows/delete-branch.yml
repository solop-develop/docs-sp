name: Delete unused S3 files

on:
  delete:

jobs:
  delete-s3-files:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      PACKAGE_NAME: docs-sp-${{ github.ref_name }}.tar.gz

  check-s3-secrets:
    name: Check if S3 information was set on secrets
    runs-on: ubuntu-latest
    outputs:
      is_have_secrets: ${{ steps.check_s3_secrets_job.outputs.is_have_secrets }}
    steps:
      - id: check_s3_secrets_job
        run: |
          if [[ "${{ vars.AWS_ACCESS_KEY_ID }}" != "" && \
                "${{ secrets.AWS_SECRET_ACCESS_KEY }}" != "" ]]; \
          then
            echo "Secrets to use S3 are configured in the repo"
            echo "is_have_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "Secrets to use S3 (`vars.AWS_ACCESS_KEY_ID`, `secrets.AWS_SECRET_ACCESS_KEY`) were not configured in the repo"
            echo "is_have_secrets=false" >> $GITHUB_OUTPUT
          fi

  upload-s3-space:
    name: Delete file on S3 space
    runs-on: ubuntu-latest
    needs:
      - check-s3-secrets
    if: needs.check-s3-secrets.outputs.is_have_secrets == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Delete from DigitalOcean Spaces
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "Eliminando archivo $PACKAGE_NAME de docs-sp/html..."
          aws s3 rm \
            s3://docs-sp/html/$PACKAGE_NAME \
            --endpoint-url https://nyc3.digitaloceanspaces.com
          echo "Proceso de eliminaci√≥n finalizado."
